<!DOCTYPE html><html lang="zh"><head><title>MD Editor</title><meta charset="utf-8"><base href=""><link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon"><link rel="stylesheet" href="./css/editormd.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"><style>html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      background: #2c2827;
    }

    .editormd {
      box-sizing: border-box;
    }

    /*设置input框的颜色*/
    input[type="file"] {
      background-color: gold;
      color: white;
    }

    /* 隐藏input元素 */
    input[type="file"] {
      display: none;
    }

    label {
        color: white;
    }</style></head><body><div id="editor"><textarea id="myTextArea" style="display:none;"></textarea></div><script src="./examples/js/jquery.min.js"></script><script src="./editormd.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/moment.js/2.26.0/moment.min.js"></script><script type="text/javascript">var md_editor=editormd("editor",{width:"100%",height:"100%",syncScrolling:"single",path:"lib/",theme:"dark",previewTheme:"dark",editorTheme:"paraiso-dark",toolbarAutoFixed:!1,saveHTMLToTextarea:!0,autoFocus:!1,emoji:!1,tex:!1,taskList:!0,tocm:!0,previewCodeHighlight:!1,searchReplace:!0,watch:!0,htmlDecode:!0,toolbar:!0,codeFold:!0,placeholder:"请输入内容...",tocTitle:"目录",flowChart:!1,sequenceDiagram:!1,toolbarIcons:function(){var e=editormd.toolbarModes.full;return(e=e.filter(function(e){return!["fullscreen","image","emoji"].includes(e)})).push("|","load_md","hand_save","create_folder","input_img","hand_export","time","<br>","img_directory","img_file","md_file"),e},toolbarCustomIcons:{load_md:'<input type="file" id="my_file" accept=".md" onchange="" style="display: none;"><li><a href="" onclick="load_md_file()" title="上传文件" unselectable="on"><i class="fa fa-upload" name="load_md" unselectable="on"></i></a></li>',input_img:'<form id="up-img-form" enctype="multipart/form-data"> <input type="file" name="image" id="image" multiple onchange="submitIMG()"> </form> <li> <a href="" onclick="input_img();return false;" title="上传图片" unselectable="on"><i class="fas fa fa-images" style="color: #777777;"></i></a> </li>',img_directory:'<form id="img-directory-form" enctype="multipart/form-data"> <label for="directory-select">MD同目录:</label> <select name="destination" id="directory-select" onchange="img_directory_select()"><option value="" selected>选择图片的存储目录:</option></select> \x3c!--<button id="submitIMG" type="submit">提交(以前用的是按钮触发提交，现在选择即触发)</button> </form>--\x3e',img_file:'<form id="img-file-form" enctype="multipart/form-data"><label for="img-select">MD同目录下IMG文件:</label> <select id="img-select" name="file" onchange=""><option value="" selected>选择需要添加的IMG文件:</option></select> \x3c!--<button type="submit">提交</button> </form>--\x3e',md_file:'<form id="md-file-form" enctype="multipart/form-data"><label for="md-select">MD文件:</label> <select id="md-select" name="file" onchange=""><option value="" selected>选择需要读取的md文件:</option></select> \x3c!--<button type="submit">提交</button> </form>--\x3e',hand_save:'<li>  <a href="" onclick="hand_save()" title="保存文件" unselectable="on">    <i class="fas fa fa-save" style="color: #777777;"></i>  </a></li><button style="display: none;" id="hand-save" type="submit">保存当前编辑器内容</button>',hand_export:'<li>  <a href="" onclick="hand_export()" title="压缩导出" unselectable="on">    <i class="fas fa fa-download" style="color: #777777;"></i>  </a></li><button style="display: none;" id="hand-export" type="submit">压缩导出</button>',time:'<li><a href="#" title="设置自动保存时间" onclick=""><i class="fas fa-history" style="color: #777777;"></i></a></li>',create_folder:'<li><a href="#" title="创建文件夹" onclick=""><i class="fas fa-folder-plus" style="color: #777777;"></i></a></li>'},lang:{toolbar:{load_md:"上传文件",input_img:"上传图片",img_directory:"图片存储位置",md_file:"显示目录下MD文件",hand_save:"手动保存编辑器内容至指定文件内",hand_export:"压缩导出",time:"自动保存时间",create_folder:"创建md文件对应的文件夹"}}});const host=window.location.hostname;let destination="",IMG_DEFAULT_DESTINATION="IMG",original_dir="./",before_filename="",after_filename="",dirselect="",fileInput;function load_md_file(){fileInput.value.split("\\").pop();fileInput.click()}function input_img(){document.getElementById("image").dispatchEvent(new MouseEvent("click"))}function submitIMG(){document.getElementById("up-img-form").click()}const imgInput=document.getElementById("image");function hand_save(){document.getElementById("hand-save").click()}function hand_export(){document.getElementById("hand-export").click()}function addOptionToSelect(e,t){var o=document.createElement("option");o.text=t,o.value=t,e.add(o),e.selectedIndex=e.options.length-1}window.onload=function(){document.getElementsByTagName("base")[0].href="./public/uploads/";var t=null,o=3600;var i,n,t=setInterval(f,500*o);document.querySelector("a[title='设置自动保存时间']").addEventListener("click",function(){var e=parseInt(prompt("请输入自动保存时间间隔（秒）:",o));!isNaN(e)&&0<e&&e!==o?(o=e,t&&clearInterval(t),t=setInterval(f,500*o)):0===e&&clearInterval(t)}),document.querySelector("a[title='创建文件夹']").addEventListener("click",function(e){const t=prompt("请输入文件夹名:");Array.from(r.options).find(e=>e.value===t)?alert("重名了"):createFolder(t,original_dir)}),c("cache");const a=document.querySelector("#md-select"),l=(fetchDirectoryTree(original_dir,a,"file","获取md文件失败"),document.querySelector("#img-select")),r=(fetchDirectoryTree(original_dir+IMG_DEFAULT_DESTINATION,l,"file","获取存放IMG目录下的图片文件选项失败"),document.querySelector("#directory-select")),e=(fetchDirectoryTree(original_dir,r,"directory","获取存放IMG文件的目录选项失败"),document.getElementById("image"));function c(t){(xhr=new XMLHttpRequest).onreadystatechange=function(){var e;4==xhr.readyState&&200==xhr.status&&(""===(e=xhr.responseText)?md_editor.cm.setValue(`---
title: ${t}
date: ${moment().format("YYYY-MM-DD HH:mm:ss")}
categories:
        - [分类]
tags:
        - 标签
---`):setTimeout(()=>{md_editor.cm.setValue(""),md_editor.cm.replaceSelection(e)},500))},xhr.open("GET",original_dir+t,!0),xhr.send()}e.addEventListener("change",async()=>{dirselect=r.value,destination=""===dirselect?original_dir+IMG_DEFAULT_DESTINATION+"/":original_dir+dirselect+"/";var t=e.files,o=[];for(let e=0;e<t.length;e++)try{(await fetch(`http://${host}:4000/md_editor/public/uploads/`+destination+t[e].name)).ok&&!confirm(`"${t[e].name}"文件已存在于图片列表中，是否替换？`)||o.push(t[e])}catch(e){console.error(e)}if(e.value=null,0<o.length){var i=new FormData;i.append("destination",destination);for(let e=0;e<o.length;e++)i.append("image",o[e]);fetch(`http://${host}:3001/upimg`,{method:"POST",body:i}).then(e=>e.json()).then(t=>{console.log(t);for(let e=0;e<t.imagePaths.length;e++){var o=t.filenames[e].split(".")[0];document.createElement("img");const i=`
![${o}](${t.imagePaths[e]})`;setTimeout(()=>{md_editor.appendMarkdown(i)},500)}}).catch(e=>{console.error(e)})}}),(fileInput=document.getElementById("my_file")).addEventListener("change",async()=>{var e=new FormData;const t=fileInput.files[0].name,o=Array.from(d.options).find(e=>e.value===t);if(o&&!confirm(`服务器上"${t}" 文件已存在. 是否替换它?`))return fileInput.value=null,void fileInput.addEventListener("change",load_md_file);e.append("md_file",fileInput.files[0]),fetch(`http://${host}:3001/upload`,{method:"POST",body:e}).then(e=>e.json()).then(e=>{console.log(e),setTimeout(()=>{c(e.filename)},500),after_filename=e.filename,o?d.value=after_filename:addOptionToSelect(d,after_filename)}).catch(e=>{console.error(e)})});const d=document.getElementById("md-select"),s=(before_filename=d.value,d.addEventListener("change",function(e){after_filename=d.options[d.selectedIndex].value,console.log("选择前："+before_filename+"\n选择后："+after_filename+"\n路径："+original_dir),f(),console.log("选择前的"+before_filename+"文件已保存"),c(after_filename);var t=Array.from(r.options).find(e=>e.value===after_filename.split(".")[0]),o=after_filename.split(".")[0];t||"cache"==o?(destination="cache"==o?(r.value=IMG_DEFAULT_DESTINATION,original_dir+IMG_DEFAULT_DESTINATION+"/"):(r.value=o,original_dir+o+"/"),fetchDirectoryTree(destination,l,"file","获取存放IMG目录下的图片文件选项失败"),console.log("目录也对应了")):confirm("是否需要新建同名文件夹？\n（如果md文件中没有图片文件可以不用创建）")?createFolder(after_filename.split(".")[0],original_dir):console.log("创建同命名文件夹失败！"),before_filename=after_filename}),document.getElementById("img-select"));function m(i,n,a){return new Promise((t,o)=>{var e=new FormData;e.append("destination",n),e.append("filename",i),e.append("currentContent",a),fetch(`http://${host}:3001/save_md`,{method:"POST",body:e}).then(e=>e.json()).then(e=>{console.log(e),e.success?(console.log(i+"保存成功！"),t(!0)):(console.log(i+"保存失败！"),t(!1))}).catch(e=>{console.error(e),console.log(i+"保存失败！"),o(!1)})})}function f(){var e=md_editor.getMarkdown();""===before_filename&&""!==e?m(before_filename="cache",original_dir,e):before_filename||e?m(before_filename,original_dir,e):console.log("输入框啥也没有无需保存")}s.addEventListener("change",function(e){IMG_filename=s.value,dirselect=r.value,destination=dirselect?original_dir+dirselect+"/":original_dir+IMG_DEFAULT_DESTINATION+"/";var t=IMG_filename.split(".")[0];document.createElement("img");const o=`
![${t}](${destination+IMG_filename})`;setTimeout(()=>{md_editor.appendMarkdown(o)},500)}),document.getElementById("hand-save").addEventListener("click",async()=>{if(before_filename=d.value,""===(i=before_filename)||"cache"==i){if(null==(i=window.prompt("请输入要保存的文件名","Untitled")))return;n=i+".md"}else n=before_filename;var e=md_editor.getMarkdown();await m(n,original_dir,e)&&(""===before_filename&&(md_editor.cm.setValue(""),m("cache",original_dir,""),console.log("cache已清空")),Array.from(d.options).find(e=>e.value===n)?d.value?console.log("下拉菜单选项无需设置，维持选择！"):(before_filename=n,d.value=before_filename,console.log(before_filename),console.log("下拉菜单选项设置成功！")):(addOptionToSelect(d,n),before_filename=n,console.log(before_filename),console.log("下拉菜单选项添加并设置成功！")),Array.from(r.options).find(e=>e.value===d.value.split(".")[0])?dirselect!=n.split(".")[0]?(r.value=n.split(".")[0],moveImagesToFolder(md_editor,e,d.value.split(".")[0],original_dir),setTimeout(()=>{f()},1e3),console.log(`目录下拉菜单已从${dirselect}改为`+n.split(".")[0]),dirselect=n.split(".")[0]):console.log("目录下拉菜单选项无需设置，维持选择！"):confirm("是否需要新建同名文件夹？\n（如果md文件中没有图片文件可以不用创建）")?await createFolder(d.value.split(".")[0],original_dir)&&(moveImagesToFolder(md_editor,e,d.value.split(".")[0],original_dir),setTimeout(()=>{f()},500)):console.log("不创建！"))}),document.getElementById("hand-export").addEventListener("click",async()=>{var e=a.value;dirselect=r.value,fetch(`http://${host}:3001/tgz_download?directoryName=${dirselect}&selectedFile=${e}&original_dir=`+original_dir).then(e=>{const t=dirselect+".tar";return e.blob().then(e=>({blob:e,tarFileName:t}))}).then(({blob:e,tarFileName:t})=>{var e=window.URL.createObjectURL(e),o=document.createElement("a");o.href=e,o.download=t,o.click()}).catch(e=>{console.error(e),alert("下载失败！")})})},window.img_directory_select=function(){dirselect=document.querySelector("#directory-select").value,destination=dirselect?original_dir+dirselect+"/":original_dir+IMG_DEFAULT_DESTINATION+"/",console.log("IMG存放目录已变更为："+destination);var e=document.querySelector("#img-select");fetchDirectoryTree(""+destination,e,"file","获取存放IMG目录下的图片文件选项失败")},window.buildOptions=function(e,t,o){if("object"==typeof e.children&&Array.isArray(e.children))for(const n of e.children){var i;n.type===o&&((i=document.createElement("option")).value=n.name,i.textContent=n.name,t.appendChild(i)),buildOptions(n,t,o)}},window.fetchDirectoryTree=function(e,t,o,i){for(;1<t.options.length;)t.remove(1);fetch(`http://${host}:3001/directory-tree?directory=`+e,{method:"GET"}).then(e=>{if(e.ok)return e.json();throw new Error("网络错误")}).then(e=>{buildOptions(e,t,o)}).catch(e=>{console.error(e),alert(i)})},window.createFolder=function(i,n){return new Promise((t,o)=>{var e=new FormData;e.append("folderName",i),e.append("folderPath",n),fetch(`http://${host}:3001/create_folder`,{method:"POST",body:e}).then(e=>e.json()).then(e=>{e.success?(console.log("文件夹创建成功！"),addOptionToSelect(dirselect=document.querySelector("#directory-select"),i),t(!0)):(console.error("文件夹创建失败：",e.message),o(e.message))}).catch(e=>{console.error("文件夹创建失败：",e),o(e)})})},window.moveImagesToFolder=function(i,n,t,a){for(var e,o=/!\[(.*?)\]\((.*?)\)/g,l={};e=o.exec(n);)if(!e[2].startsWith("http")){var r=e[2].split("/"),c=r[r.length-2];const d=r[r.length-1];c!==t?((r=new FormData).append("fileName",d),r.append("folderName",c),r.append("new_folderName",t),r.append("original_dir",a),r.append("match",JSON.stringify(e)),moveImageToFolder(r).then(e=>{var{new_folderName:t,fileName:o}=e,e=JSON.parse(e.match),t=`![${e[1]}](${a}${t}/${o})`;n=n.replace(e[0],t),setTimeout(()=>{i.setMarkdown(n)},500),console.log(e[0]+"更改为"+t)}).catch(e=>{console.error(`Error moving image ${d} to ${t}: `+e)})):(l[c]=l[c]||[],l[c].push(d))}},window.moveImageToFolder=function(e){return new Promise((t,o)=>{const i=new XMLHttpRequest;i.open("POST",`http://${host}:3001/move_image`),i.onreadystatechange=function(){var e;4===i.readyState&&200===i.status?(e=JSON.parse(i.responseText)).success?(e.data,console.log(e),t(e.data)):o(e.error):4===i.readyState&&200!==i.status&&o("Error moving image formData.get('fileName') to formData.get('folderName'): formData.get('xhr.statusText)")},i.send(e)})};</script></body></html>