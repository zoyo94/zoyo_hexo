<!DOCTYPE html><html lang="zh"><head><title>MD Editor</title><meta charset="utf-8"><base href="./"><link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon"><link rel="stylesheet" href="./css/editormd.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"><style>html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            background: #2c2827;
        }

        .editormd { box-sizing: border-box; }

        input[type="file"] {
            display: none;
            background-color: gold;
            color: white;
        }

        label { color: white; }</style></head><body><div id="editor"><textarea id="myTextArea" style="display:none;"></textarea></div><script src="./examples/js/jquery.min.js"></script><script src="./editormd.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/moment.js/2.26.0/moment.min.js"></script><script type="text/javascript">let CONFIG={HOST:window.location.hostname,DEFAULT_IMG_DIR:"IMG",ORIGINAL_DIR:"./",DEFAULT_AUTOSAVE_INTERVAL:3600,PORTS:{UPLOAD:3001,SERVE:4e3}},mdEditor=editormd("editor",{width:"100%",height:"100%",syncScrolling:"single",path:"lib/",theme:"dark",previewTheme:"dark",editorTheme:"paraiso-dark",toolbarAutoFixed:!1,saveHTMLToTextarea:!0,autoFocus:!1,searchReplace:!0,watch:!0,htmlDecode:!0,toolbar:!0,codeFold:!0,placeholder:"请输入内容...",tocm:!0,tocTitle:"目录",taskList:!0,toolbarIcons:function(){return[...editormd.toolbarModes.full.filter(e=>!["fullscreen","image","emoji"].includes(e)),"|","load_md","hand_save","create_folder","input_img","hand_export","time","<br>","img_directory","img_file","md_file"]},toolbarCustomIcons:{load_md:'<input type="file" id="my_file" accept=".md"><li><a href="#" onclick="loadMdFile()" title="上传文件"><i class="fa fa-upload"></i></a></li>',input_img:'<form id="up-img-form" enctype="multipart/form-data"><input type="file" name="image" id="image" multiple onchange="submitImg()"></form><li><a href="#" onclick="inputImg();return false;" title="上传图片"><i class="fas fa fa-images" style="color: #777777;"></i></a></li>',img_directory:'<form id="img-directory-form"><label for="directory-select">MD同目录:</label><select name="destination" id="directory-select" onchange="imgDirectorySelect()"><option value="" selected>选择图片的存储目录:</option></select></form>',img_file:'<form id="img-file-form"><label for="img-select">MD同目录下IMG文件:</label><select id="img-select" name="file"><option value="" selected>选择需要添加的IMG文件:</option></select></form>',md_file:'<form id="md-file-form"><label for="md-select">MD文件:</label><select id="md-select" name="file"><option value="" selected>选择需要读取的md文件:</option></select></form>',hand_save:'<li><a href="#" onclick="handSave()" title="保存文件"><i class="fas fa fa-save" style="color: #777777;"></i></a></li><button style="display: none;" id="hand-save">保存当前编辑器内容</button>',hand_export:'<li><a href="#" onclick="handExport()" title="压缩导出"><i class="fas fa fa-download" style="color: #777777;"></i></a></li><button style="display: none;" id="hand-export">压缩导出</button>',time:'<li><a href="#" title="设置自动保存时间" onclick="setAutoSaveInterval();return false;"><i class="fas fa-history" style="color: #777777;"></i></a></li>',create_folder:'<li><a href="#" title="创建文件夹" onclick="createFolderPrompt();return false;"><i class="fas fa-folder-plus" style="color: #777777;"></i></a></li>'},lang:{toolbar:{load_md:"上传文件",input_img:"上传图片",img_directory:"图片存储位置",md_file:"显示目录下MD文件",hand_save:"手动保存编辑器内容至指定文件内",hand_export:"压缩导出",time:"自动保存时间",create_folder:"创建md文件对应的文件夹"}}}),state={destination:"",beforeFilename:"",afterFilename:"",dirSelect:"",autoSaveIntervalId:null,autoSaveIntervalSeconds:CONFIG.DEFAULT_AUTOSAVE_INTERVAL},DOM={},appendMarkdownDelayed=(e,t=500)=>{setTimeout(()=>mdEditor.appendMarkdown(e),t)},fetchJson=async(e,t={})=>{e=await fetch(e,t);if(e.ok)return e.json();throw new Error("HTTP错误！状态: "+e.status)};function loadMdFile(){DOM.fileInput.click()}function inputImg(){DOM.imgInput.click()}function submitImg(){DOM.imgInput.dispatchEvent(new Event("change"))}function handSave(){DOM.handSaveBtn.click()}function handExport(){DOM.handExportBtn.click()}async function saveMd(t,e,a){var o=new FormData;o.append("destination",e),o.append("filename",t),o.append("currentContent",a);try{var l=await fetchJson(`http://${CONFIG.HOST}:${CONFIG.PORTS.UPLOAD}/save_md`,{method:"POST",body:o});return console.log(`${t} 保存${l.success?"成功":"失败"}！`),l.success}catch(e){return console.error(`保存 ${t} 失败:`,e),!1}}function autoSave(){var e=mdEditor.getMarkdown();e?(state.beforeFilename||(state.beforeFilename="cache"),saveMd(state.beforeFilename,CONFIG.ORIGINAL_DIR,e)):console.log("输入框为空，无需保存")}async function getContent(t){let a=new XMLHttpRequest;a.open("GET",""+CONFIG.ORIGINAL_DIR+t,!0),a.onreadystatechange=function(){if(4===a.readyState&&200===a.status){let e=a.responseText||`---
title: ${t}
date: ${moment().format("YYYY-MM-DD HH:mm:ss")}
categories:
    - [分类]
tags:
    - 标签
---`;setTimeout(()=>{mdEditor.cm.setValue(e)},500)}},a.send()}function setAutoSaveInterval(){var e=parseInt(prompt("请输入自动保存时间间隔（秒）:",state.autoSaveIntervalSeconds));!isNaN(e)&&0<e&&e!==state.autoSaveIntervalSeconds?(state.autoSaveIntervalSeconds=e,state.autoSaveIntervalId&&clearInterval(state.autoSaveIntervalId),state.autoSaveIntervalId=setInterval(autoSave,1e3*e)):0===e&&clearInterval(state.autoSaveIntervalId)}async function createFolderPrompt(){let t=prompt("请输入文件夹名:");t&&!Array.from(DOM.directorySelect.options).some(e=>e.value===t)?await createFolder(t,CONFIG.ORIGINAL_DIR):t&&alert("文件夹名已存在！")}async function handleFileUpload(){var t=new FormData;let a=DOM.fileInput.files[0].name;var o=Array.from(DOM.mdSelect.options).find(e=>e.value===a);if(o&&!confirm(`服务器上"${a}" 文件已存在，是否替换？`))return void(DOM.fileInput.value=null);t.append("md_file",DOM.fileInput.files[0]);try{let e=await fetchJson(`http://${CONFIG.HOST}:${CONFIG.PORTS.UPLOAD}/upload`,{method:"POST",body:t});console.log("上传成功:",e),state.afterFilename=e.filename,setTimeout(()=>getContent(e.filename),500),o?DOM.mdSelect.value=state.afterFilename:addOptionToSelect(DOM.mdSelect,state.afterFilename)}catch(e){console.error("上传失败:",e)}DOM.fileInput.value=null}async function handleImageUpload(){state.dirSelect=DOM.directorySelect.value,state.destination=state.dirSelect?""+CONFIG.ORIGINAL_DIR+state.dirSelect+"/":""+CONFIG.ORIGINAL_DIR+CONFIG.DEFAULT_IMG_DIR+"/";var a=DOM.imgInput.files,o=[];for(let t=0;t<a.length;t++)try{(await fetch(`http://${CONFIG.HOST}:${CONFIG.PORTS.SERVE}/md_editor/public/uploads/`+state.destination+a[t].name)).ok&&!confirm(`"${a[t].name}" 已存在，是否替换？`)||o.push(a[t])}catch(e){console.error("检查文件存在性失败:",e),o.push(a[t])}if(0<o.length){let t=new FormData;t.append("destination",state.destination),o.forEach(e=>t.append("image",e));try{let a=await fetchJson(`http://${CONFIG.HOST}:${CONFIG.PORTS.UPLOAD}/upimg`,{method:"POST",body:t});console.log("图片上传成功:",a),a.imagePaths.forEach((e,t)=>{t=`
![${a.filenames[t].split(".")[0]}](${e})`;appendMarkdownDelayed(t)})}catch(e){console.error("图片上传失败:",e)}}DOM.imgInput.value=null}async function handleMdSelectChange(){state.afterFilename=DOM.mdSelect.value,console.log(`选择前: ${state.beforeFilename}, 选择后: `+state.afterFilename),await autoSave(),console.log(`选择前的${state.beforeFilename}已保存`),await getContent(state.afterFilename);let t=state.afterFilename.split(".")[0];Array.from(DOM.directorySelect.options).find(e=>e.value===t)||"cache"===t?(state.destination="cache"===t?""+CONFIG.ORIGINAL_DIR+CONFIG.DEFAULT_IMG_DIR+"/":""+CONFIG.ORIGINAL_DIR+t+"/",DOM.directorySelect.value="cache"===t?CONFIG.DEFAULT_IMG_DIR:t,await fetchDirectoryTree(state.destination,DOM.imgSelect,"file","获取IMG文件失败"),console.log("目录已同步")):confirm("是否创建同名文件夹？\n（无图片可不创建）")&&await createFolder(t,CONFIG.ORIGINAL_DIR),state.beforeFilename=state.afterFilename}async function handleImgSelectChange(){var e=DOM.imgSelect.value,t=(state.dirSelect=DOM.directorySelect.value,state.destination=state.dirSelect?""+CONFIG.ORIGINAL_DIR+state.dirSelect+"/":""+CONFIG.ORIGINAL_DIR+CONFIG.DEFAULT_IMG_DIR+"/",e.split(".")[0]),t=`
![${t}](${state.destination}${e})`;appendMarkdownDelayed(t)}async function handleManualSave(){state.beforeFilename=DOM.mdSelect.value;let e=state.beforeFilename||"cache",t;if(e&&"cache"!==e)t=e;else{if(!(e=prompt("请输入文件名","Untitled")))return;t=e+".md"}var a=mdEditor.getMarkdown();await saveMd(t,CONFIG.ORIGINAL_DIR,a)&&(state.beforeFilename||(await saveMd("cache",CONFIG.ORIGINAL_DIR,""),console.log("cache已清空")),Array.from(DOM.mdSelect.options).find(e=>e.value===t)?DOM.mdSelect.value||(state.beforeFilename=t,DOM.mdSelect.value=t,console.log("下拉菜单更新成功")):(addOptionToSelect(DOM.mdSelect,t),state.beforeFilename=t,console.log("下拉菜单添加成功")),Array.from(DOM.directorySelect.options).find(e=>e.value===t.split(".")[0])?state.dirSelect!==t.split(".")[0]&&(DOM.directorySelect.value=t.split(".")[0],await moveImagesToFolder(mdEditor,a,t.split(".")[0],CONFIG.ORIGINAL_DIR),setTimeout(autoSave,1e3),state.dirSelect=t.split(".")[0],console.log("目录变更为"+state.dirSelect)):confirm("是否创建同名文件夹？\n（无图片可不创建）")&&await createFolder(t.split(".")[0],CONFIG.ORIGINAL_DIR)&&(await moveImagesToFolder(mdEditor,a,t.split(".")[0],CONFIG.ORIGINAL_DIR),setTimeout(autoSave,500)))}async function handleExport(){var e=DOM.mdSelect.value;state.dirSelect=DOM.directorySelect.value;try{var t=await(await fetch(`http://${CONFIG.HOST}:${CONFIG.PORTS.UPLOAD}/tgz_download?directoryName=${state.dirSelect}&selectedFile=${e}&original_dir=`+CONFIG.ORIGINAL_DIR)).blob(),a=window.URL.createObjectURL(t),o=document.createElement("a");o.href=a,o.download=state.dirSelect+".tar",o.click()}catch(e){console.error("导出失败:",e),alert("下载失败！")}}function addOptionToSelect(e,t){var a=document.createElement("option");a.text=t,a.value=t,e.add(a),e.selectedIndex=e.options.length-1}window.onload=async()=>{var e,t,a=document.getElementsByTagName("base")[0];a?(a.href="./public/uploads/",console.log("Base href 已设置为 ./public/uploads/")):console.error("未找到 base 标签，无法设置 href"),Object.assign(DOM,{fileInput:document.getElementById("my_file"),imgInput:document.getElementById("image"),mdSelect:document.getElementById("md-select"),imgSelect:document.getElementById("img-select"),directorySelect:document.getElementById("directory-select"),handSaveBtn:document.getElementById("hand-save"),handExportBtn:document.getElementById("hand-export")});for([e,t]of Object.entries(DOM))t||console.warn(`DOM元素 ${e} 未找到，可能导致功能异常`);state.autoSaveIntervalId=setInterval(autoSave,1e3*state.autoSaveIntervalSeconds),DOM.fileInput.addEventListener("change",handleFileUpload),DOM.imgInput.addEventListener("change",handleImageUpload),DOM.mdSelect.addEventListener("change",handleMdSelectChange),DOM.imgSelect.addEventListener("change",handleImgSelectChange),DOM.handSaveBtn.addEventListener("click",handleManualSave),DOM.handExportBtn.addEventListener("click",handleExport),await Promise.all([getContent("cache"),fetchDirectoryTree(CONFIG.ORIGINAL_DIR,DOM.mdSelect,"file","获取md文件失败"),fetchDirectoryTree(""+CONFIG.ORIGINAL_DIR+CONFIG.DEFAULT_IMG_DIR,DOM.imgSelect,"file","获取IMG文件失败"),fetchDirectoryTree(CONFIG.ORIGINAL_DIR,DOM.directorySelect,"directory","获取目录失败")])},window.fetchDirectoryTree=async(e,t,a,o)=>{for(;1<t.options.length;)t.remove(1);try{var l=await fetchJson(`http://${CONFIG.HOST}:${CONFIG.PORTS.UPLOAD}/directory-tree?directory=`+e);buildOptions(l,t,a)}catch(e){console.error(e),alert(o)}},window.buildOptions=(e,t,a)=>{if(Array.isArray(e.children))for(var o of e.children){var l;o.type===a&&((l=document.createElement("option")).value=o.name,l.textContent=o.name,t.appendChild(l)),buildOptions(o,t,a)}},window.createFolder=async(e,t)=>{var a=new FormData;a.append("folderName",e),a.append("folderPath",t);try{var o=await fetchJson(`http://${CONFIG.HOST}:${CONFIG.PORTS.UPLOAD}/create_folder`,{method:"POST",body:a});return o.success?(console.log("文件夹创建成功！"),addOptionToSelect(DOM.directorySelect,e),!0):(console.error("文件夹创建失败：",o.message),!1)}catch(e){return console.error("文件夹创建失败：",e),!1}},window.imgDirectorySelect=()=>{state.dirSelect=DOM.directorySelect.value,state.destination=state.dirSelect?""+CONFIG.ORIGINAL_DIR+state.dirSelect+"/":""+CONFIG.ORIGINAL_DIR+CONFIG.DEFAULT_IMG_DIR+"/",console.log("IMG存放目录已变更为："+state.destination),fetchDirectoryTree(state.destination,DOM.imgSelect,"file","获取IMG文件失败")},window.moveImagesToFolder=async(e,t,a,o)=>{for(var l,n=/!\[(.*?)\]\((.*?)\)/g;l=n.exec(t);)if(!l[2].startsWith("http")){var i=l[2].split("/"),r=i[i.length-2],i=i[i.length-1];if(r!==a){var c=new FormData;c.append("fileName",i),c.append("folderName",r),c.append("new_folderName",a),c.append("original_dir",o),c.append("match",JSON.stringify(l));try{var d=await moveImageToFolder(c),s=`![${l[1]}](${o}${d.new_folderName}/${d.fileName})`;t=t.replace(l[0],s),setTimeout(()=>e.setMarkdown(t),500),console.log(l[0]+" 已更改为 "+s)}catch(e){console.error(`移动图片 ${i} 失败:`,e)}}}},window.moveImageToFolder=e=>new Promise((t,a)=>{let o=new XMLHttpRequest;o.open("POST",`http://${CONFIG.HOST}:${CONFIG.PORTS.UPLOAD}/move_image`),o.onreadystatechange=function(){var e;4===o.readyState&&200===o.status?(e=JSON.parse(o.responseText)).success?t(e.data):a(e.error):4===o.readyState&&a("移动图片失败: "+o.statusText)},o.send(e)});</script></body></html>