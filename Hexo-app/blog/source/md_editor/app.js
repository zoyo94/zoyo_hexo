const a0_0x3ec052=a0_0x4890;(function(_0x2279e4,_0x4fb94f){const _0x4ae37c=a0_0x4890,_0x303b0e=_0x2279e4();while(!![]){try{const _0x5149a4=parseInt(_0x4ae37c(0x21d))/0x1*(parseInt(_0x4ae37c(0x1ea))/0x2)+parseInt(_0x4ae37c(0x228))/0x3*(parseInt(_0x4ae37c(0x207))/0x4)+-parseInt(_0x4ae37c(0x1eb))/0x5*(-parseInt(_0x4ae37c(0x1e6))/0x6)+-parseInt(_0x4ae37c(0x1bc))/0x7*(parseInt(_0x4ae37c(0x1ba))/0x8)+parseInt(_0x4ae37c(0x1ff))/0x9*(-parseInt(_0x4ae37c(0x1cc))/0xa)+-parseInt(_0x4ae37c(0x1bd))/0xb*(-parseInt(_0x4ae37c(0x1dc))/0xc)+parseInt(_0x4ae37c(0x21f))/0xd*(-parseInt(_0x4ae37c(0x210))/0xe);if(_0x5149a4===_0x4fb94f)break;else _0x303b0e['push'](_0x303b0e['shift']());}catch(_0x13e37e){_0x303b0e['push'](_0x303b0e['shift']());}}}(a0_0x35ce,0x4a69d));const express=require('express'),multer=require(a0_0x3ec052(0x1ee)),fs=require('fs'),path=require(a0_0x3ec052(0x1da)),cors=require(a0_0x3ec052(0x223)),tar=require('tar'),winston=require('winston'),CONFIG={'WORK_DIR':path[a0_0x3ec052(0x1f6)](__dirname,'public',a0_0x3ec052(0x1f0)),'PORT':0xbb9,'MD_FILE_SIZE_LIMIT':0x5*0x400*0x400,'IMG_FILE_SIZE_LIMIT':0x32*0x400*0x400};function a0_0x35ce(){const _0x3f2ce6=['/upload','query','pipe','application/json','\x20移动至\x20','application/octet-stream','binary','basename','body','toString','buffer','length','8PZXhcr','Fetched\x20directory\x20tree\x20for:\x20','2829547SjhPLx','51007tKXLXu','file','resolve','MD\x20文件上传成功','文件写入成功❤️','缺少必要参数:\x20directoryName\x20或\x20original_dir','\x20from\x20','Uploaded\x20MD\x20file:\x20','simple','create','未上传文件','array','from','/directory-tree','post','10OCmFgp','目录创建成功❤️','single','toLowerCase','mkdirSync','\x20to\x20','Markdown\x20content\x20check:\x20','Created\x20directory:\x20','attachment;\x20filename=\x22','utf-8','json','destination','Uploaded\x20file:\x20','缺少目录参数','path','文件\x20','72kVeUqZ','目录已存在','utf8','combine','catch','Exported:\x20','files','\x20从\x20','PORT','production','18NJfOMb','Moved\x20','listen','MD_FILE_SIZE_LIMIT','3766IrmqDz','738975oMrRry','Console','map','multer','/move_image','uploads','originalname','folder\x20and\x20MD\x20file','IMG_FILE_SIZE_LIMIT','use','md_file','join','createLogger','extname','Content-Type','dirname','set','文件夹\x20','\x20不存在','format','959283UInyHS','WORK_DIR','File','/tgz_download','Saved\x20MD\x20file:\x20','服务已启动，监听端口\x20','服务器错误','then','499176GXWMJs','get','error','Created\x20folder:\x20','relative','Exported\x20folder:\x20','push','name','all','14iUhpFh','existsSync','/create_folder','缺少必要参数','上传的文件必须为\x20.md\x20格式','image','info','文件夹上传成功','status','writeFile','mkdir','none','promises','213EhJUAQ','transports','5603819kSCsOG','test','/upload-folder','Content-Disposition','cors','replace','error.log','directory','\x20-\x20','9cdPVhi','.tar','图片上传成功❤️'];a0_0x35ce=function(){return _0x3f2ce6;};return a0_0x35ce();}process['chdir'](CONFIG[a0_0x3ec052(0x200)]);const app=express();app[a0_0x3ec052(0x1f4)](cors()),app[a0_0x3ec052(0x1f4)](express[a0_0x3ec052(0x1d6)]({'type':a0_0x3ec052(0x1b1),'charset':a0_0x3ec052(0x1d5)}));function a0_0x4890(_0x5b7633,_0x3095b3){const _0x35cecf=a0_0x35ce();return a0_0x4890=function(_0x4890fd,_0x37d04f){_0x4890fd=_0x4890fd-0x1ae;let _0x3fce37=_0x35cecf[_0x4890fd];return _0x3fce37;},a0_0x4890(_0x5b7633,_0x3095b3);}const logger=winston[a0_0x3ec052(0x1f7)]({'level':a0_0x3ec052(0x216),'format':winston[a0_0x3ec052(0x1fe)][a0_0x3ec052(0x1df)](winston[a0_0x3ec052(0x1fe)]['timestamp'](),winston[a0_0x3ec052(0x1fe)][a0_0x3ec052(0x1d6)]()),'transports':[new winston[(a0_0x3ec052(0x21e))][(a0_0x3ec052(0x201))]({'filename':path[a0_0x3ec052(0x1f6)](__dirname,a0_0x3ec052(0x225)),'level':a0_0x3ec052(0x209)}),new winston[(a0_0x3ec052(0x21e))][(a0_0x3ec052(0x201))]({'filename':path['join'](__dirname,'combined.log')})]});process['env']['NODE_ENV']!==a0_0x3ec052(0x1e5)&&logger['add'](new winston[(a0_0x3ec052(0x21e))][(a0_0x3ec052(0x1ec))]({'format':winston[a0_0x3ec052(0x1fe)][a0_0x3ec052(0x1c5)]()}));const createMulter=(_0x3ddf93,_0x3477e3)=>multer({'storage':multer['memoryStorage'](),'limits':{'fileSize':_0x3ddf93},'fileFilter':_0x3477e3}),uploadMd=createMulter(CONFIG[a0_0x3ec052(0x1e9)],(_0x431dbf,_0x19130f,_0x496c6d)=>{const _0x4e78a6=a0_0x3ec052,_0x194063=/md/,_0x4a0fc2=_0x194063[_0x4e78a6(0x220)](path[_0x4e78a6(0x1f8)](_0x19130f['originalname'])[_0x4e78a6(0x1cf)]());_0x4a0fc2?_0x496c6d(null,!![]):_0x496c6d(new Error(_0x4e78a6(0x214)));}),uploadImg=createMulter(CONFIG[a0_0x3ec052(0x1f3)]),noFileUpload=createMulter(),writeFile=(_0x21edc4,_0x17c728)=>new Promise((_0x6776dd,_0x2dab06)=>{const _0x589080=a0_0x3ec052;fs[_0x589080(0x219)](_0x21edc4,_0x17c728,_0x4c0ec6=>{_0x4c0ec6?_0x2dab06(_0x4c0ec6):_0x6776dd();});}),readDirectory=_0x475d70=>new Promise((_0x5cda24,_0x34dfd1)=>{const _0x17dbcc=a0_0x3ec052;fs['readdir'](_0x475d70,{'withFileTypes':!![],'encoding':_0x17dbcc(0x1de)},(_0x5a5508,_0x1c1edd)=>{const _0xc8d983=_0x17dbcc;if(_0x5a5508)return _0x34dfd1(_0x5a5508);const _0x4fd497=_0x1c1edd[_0xc8d983(0x1ed)](_0x1b70cd=>{const _0x39eeae=_0xc8d983,_0x47fae6=path[_0x39eeae(0x1f6)](_0x475d70,_0x1b70cd['name']);return _0x1b70cd['isDirectory']()?readDirectory(_0x47fae6)[_0x39eeae(0x206)](_0x389197=>({'name':_0x1b70cd[_0x39eeae(0x20e)],'children':_0x389197,'type':'directory'})):Promise[_0x39eeae(0x1bf)]({'name':_0x1b70cd[_0x39eeae(0x20e)],'type':_0x39eeae(0x1be)});});Promise[_0xc8d983(0x20f)](_0x4fd497)['then'](_0x3b928c=>_0x5cda24({'name':path[_0xc8d983(0x1b5)](_0x475d70),'children':_0x3b928c}))[_0xc8d983(0x1e0)](_0x34dfd1);});}),getRelativePath=_0x47d539=>path[a0_0x3ec052(0x20b)](__dirname,_0x47d539),errorHandler=(_0x1809cb,_0x4d704e,_0x14459d,_0x337e2c)=>{const _0x396cbd=a0_0x3ec052;logger[_0x396cbd(0x209)]('Error:\x20'+_0x1809cb['message']),_0x14459d[_0x396cbd(0x218)](0x1f4)[_0x396cbd(0x1d6)]({'success':![],'message':_0x1809cb['message']||_0x396cbd(0x205)});};app[a0_0x3ec052(0x1cb)](a0_0x3ec052(0x1ae),uploadMd[a0_0x3ec052(0x1ce)](a0_0x3ec052(0x1f5)),async(_0x5b958a,_0x5d1cf8,_0x277a9a)=>{const _0x41a8bc=a0_0x3ec052;try{if(!_0x5b958a[_0x41a8bc(0x1be)])throw new Error(_0x41a8bc(0x1c7));const _0x39c88a=Buffer[_0x41a8bc(0x1c9)](_0x5b958a[_0x41a8bc(0x1be)][_0x41a8bc(0x1f1)],_0x41a8bc(0x1b4))[_0x41a8bc(0x1b7)](_0x41a8bc(0x1de)),_0x37e31f=path[_0x41a8bc(0x1f6)](CONFIG['WORK_DIR'],_0x39c88a);await writeFile(_0x37e31f,_0x5b958a[_0x41a8bc(0x1be)][_0x41a8bc(0x1b8)]),logger[_0x41a8bc(0x216)](_0x41a8bc(0x1c4)+getRelativePath(_0x37e31f)),_0x5d1cf8[_0x41a8bc(0x1d6)]({'success':!![],'message':_0x41a8bc(0x1c0),'filePath':_0x37e31f,'filename':_0x39c88a,'destination':'./'});}catch(_0x155fe9){_0x277a9a(_0x155fe9);}}),app[a0_0x3ec052(0x1cb)]('/upimg',uploadImg[a0_0x3ec052(0x1c8)](a0_0x3ec052(0x215)),async(_0x2e2b50,_0x331648,_0x2fcfbb)=>{const _0x5451f1=a0_0x3ec052;try{const _0x216503=_0x2e2b50[_0x5451f1(0x1b6)][_0x5451f1(0x1d7)]||'./',_0x3cfde9=path[_0x5451f1(0x1f6)](CONFIG[_0x5451f1(0x200)],_0x216503[_0x5451f1(0x224)](/^\.\//,'')),_0x331865=[],_0x20e56a=[];!fs['existsSync'](_0x3cfde9)&&(await fs[_0x5451f1(0x21c)]['mkdir'](_0x3cfde9,{'recursive':!![]}),logger['info'](_0x5451f1(0x1d3)+getRelativePath(_0x3cfde9)));for(const _0x264f30 of _0x2e2b50[_0x5451f1(0x1e2)]){const _0x449b08=Buffer[_0x5451f1(0x1c9)](_0x264f30[_0x5451f1(0x1f1)],_0x5451f1(0x1b4))[_0x5451f1(0x1b7)](_0x5451f1(0x1de)),_0x549942=path['join'](_0x3cfde9,_0x449b08);await writeFile(_0x549942,_0x264f30[_0x5451f1(0x1b8)]),_0x331865[_0x5451f1(0x20d)](''+_0x216503+_0x449b08),_0x20e56a[_0x5451f1(0x20d)](_0x449b08),logger[_0x5451f1(0x216)]('Uploaded\x20image:\x20'+getRelativePath(_0x549942)+_0x5451f1(0x1d1)+_0x216503);}_0x331648[_0x5451f1(0x1d6)]({'success':!![],'message':_0x5451f1(0x22a),'imagePaths':_0x331865,'filenames':_0x20e56a,'destination':_0x216503});}catch(_0x51903b){_0x2fcfbb(_0x51903b);}}),app['post'](a0_0x3ec052(0x221),uploadImg['array']('files'),async(_0x4e99ab,_0xbe0dda,_0x2a8bba)=>{const _0x3996dc=a0_0x3ec052;try{const _0x3d769a=_0x4e99ab[_0x3996dc(0x1b6)]['folderName'];if(!_0x3d769a||!_0x4e99ab[_0x3996dc(0x1e2)]||_0x4e99ab['files'][_0x3996dc(0x1b9)]===0x0)throw new Error('缺少必要参数或文件');const _0x30d331=[],_0x404870=[];for(const _0x157c3c of _0x4e99ab['files']){const _0x1a8e8f=Buffer[_0x3996dc(0x1c9)](_0x157c3c[_0x3996dc(0x1f1)],_0x3996dc(0x1b4))[_0x3996dc(0x1b7)](_0x3996dc(0x1de)),_0x3b1b9c=path[_0x3996dc(0x1f6)](CONFIG['WORK_DIR'],_0x3d769a,_0x1a8e8f),_0x412043=path[_0x3996dc(0x1fa)](_0x3b1b9c);!fs[_0x3996dc(0x211)](_0x412043)&&(fs[_0x3996dc(0x1d0)](_0x412043,{'recursive':!![]}),logger['info'](_0x3996dc(0x1d3)+getRelativePath(_0x412043))),await writeFile(_0x3b1b9c,_0x157c3c[_0x3996dc(0x1b8)]),_0x30d331[_0x3996dc(0x20d)](_0x3d769a+'/'+_0x1a8e8f),_0x404870[_0x3996dc(0x20d)](_0x1a8e8f),logger[_0x3996dc(0x216)](_0x3996dc(0x1d8)+getRelativePath(_0x3b1b9c)+_0x3996dc(0x1d1)+_0x3d769a);}_0xbe0dda[_0x3996dc(0x1d6)]({'success':!![],'message':_0x3996dc(0x217),'filePaths':_0x30d331,'filenames':_0x404870,'destination':'./'+_0x3d769a+'/'});}catch(_0x77e18d){_0x2a8bba(_0x77e18d);}}),app[a0_0x3ec052(0x208)](a0_0x3ec052(0x1ca),async(_0x338a74,_0x182304,_0x127790)=>{const _0x2d24e3=a0_0x3ec052;try{const _0x295da7=_0x338a74[_0x2d24e3(0x1af)][_0x2d24e3(0x226)];if(!_0x295da7)throw new Error('缺少目录参数');const _0x3cc586=await readDirectory(_0x295da7);logger['info'](_0x2d24e3(0x1bb)+getRelativePath(_0x295da7)),_0x182304['json'](_0x3cc586);}catch(_0x4df294){_0x127790(_0x4df294);}}),app[a0_0x3ec052(0x1cb)]('/save_md',noFileUpload[a0_0x3ec052(0x1ce)](a0_0x3ec052(0x1be)),async(_0x5132a1,_0x421f4e,_0x173145)=>{const _0x192d85=a0_0x3ec052;try{const {destination:_0x48d5dc,filename:_0x2755ab,currentContent:_0x10d503}=_0x5132a1[_0x192d85(0x1b6)];if(!_0x48d5dc||!_0x2755ab||!_0x10d503)throw new Error('缺少必要参数');const _0xba14c9=Buffer[_0x192d85(0x1c9)](_0x2755ab,_0x192d85(0x1b4))[_0x192d85(0x1b7)](_0x192d85(0x1de)),_0x1bf2a5=path[_0x192d85(0x1f6)](CONFIG[_0x192d85(0x200)],_0x48d5dc[_0x192d85(0x224)](/^\.\//,''),_0xba14c9);await writeFile(_0x1bf2a5,_0x10d503),logger[_0x192d85(0x216)](_0x192d85(0x203)+getRelativePath(_0x1bf2a5)+_0x192d85(0x1d1)+_0x48d5dc),_0x421f4e['json']({'success':!![],'message':_0x192d85(0x1c1),'filepath':_0xba14c9});}catch(_0x231a8c){_0x173145(_0x231a8c);}}),app[a0_0x3ec052(0x1cb)](a0_0x3ec052(0x212),noFileUpload[a0_0x3ec052(0x1ce)](a0_0x3ec052(0x1be)),async(_0x102e1d,_0x13a4ee,_0x1cf7ee)=>{const _0x5250c4=a0_0x3ec052;try{const {folderPath:_0xc05a9d,folderName:_0x349a3b}=_0x102e1d[_0x5250c4(0x1b6)];if(!_0xc05a9d||!_0x349a3b)throw new Error(_0x5250c4(0x1d9));const _0x1bcca6=path[_0x5250c4(0x1f6)](CONFIG['WORK_DIR'],_0xc05a9d[_0x5250c4(0x224)](/^\.\//,''),_0x349a3b);if(fs['existsSync'](_0x1bcca6))throw new Error(_0x5250c4(0x1dd));await fs[_0x5250c4(0x21c)][_0x5250c4(0x21a)](_0x1bcca6),logger[_0x5250c4(0x216)](_0x5250c4(0x20a)+getRelativePath(_0x1bcca6)),_0x13a4ee[_0x5250c4(0x1d6)]({'success':!![],'message':_0x5250c4(0x1cd),'folderpath':'./'+_0x349a3b+'/'});}catch(_0x23ef0e){_0x1cf7ee(_0x23ef0e);}}),app['post'](a0_0x3ec052(0x1ef),noFileUpload[a0_0x3ec052(0x1ce)](a0_0x3ec052(0x1be)),async(_0x2f673d,_0xa514b7,_0x3ca44f)=>{const _0x3c50e4=a0_0x3ec052;try{const {folderName:_0x67b006,fileName:_0x3f7cea,new_folderName:_0x34a41e,original_dir:_0x280e6c}=_0x2f673d[_0x3c50e4(0x1b6)];if(!_0x67b006||!_0x3f7cea||!_0x34a41e||!_0x280e6c)throw new Error(_0x3c50e4(0x213));const _0x5702d8=Buffer[_0x3c50e4(0x1c9)](_0x3f7cea,'binary')['toString'](_0x3c50e4(0x1de)),_0x5f2cb6=path[_0x3c50e4(0x1f6)](CONFIG[_0x3c50e4(0x200)],_0x67b006,_0x5702d8),_0x538e28=path[_0x3c50e4(0x1f6)](CONFIG['WORK_DIR'],_0x34a41e,_0x5702d8);!fs[_0x3c50e4(0x211)](path['dirname'](_0x538e28))&&(await fs[_0x3c50e4(0x21c)]['mkdir'](path[_0x3c50e4(0x1fa)](_0x538e28),{'recursive':!![]}),logger[_0x3c50e4(0x216)](_0x3c50e4(0x1d3)+getRelativePath(path['dirname'](_0x538e28)))),await fs[_0x3c50e4(0x21c)]['rename'](_0x5f2cb6,_0x538e28),logger[_0x3c50e4(0x216)](_0x3c50e4(0x1e7)+_0x5702d8+_0x3c50e4(0x1c3)+_0x67b006+_0x3c50e4(0x1d1)+_0x34a41e),_0xa514b7[_0x3c50e4(0x1d6)]({'success':!![],'message':'图片移动成功❤️，已将\x20'+_0x5702d8+_0x3c50e4(0x1e3)+_0x67b006+_0x3c50e4(0x1b2)+_0x34a41e,'data':{'original_dir':_0x280e6c,'folderName':_0x67b006,'fileName':_0x5702d8,'new_folderName':_0x34a41e}});}catch(_0x29d13f){_0x3ca44f(_0x29d13f);}}),app[a0_0x3ec052(0x1cb)](a0_0x3ec052(0x202),noFileUpload[a0_0x3ec052(0x21b)](),async(_0x2b1a3b,_0x33a35a,_0x4d44ea)=>{const _0x5c1831=a0_0x3ec052;try{const {directoryName:_0x5c5b45,selectedFile:_0x2d1dda,original_dir:_0x1ecea4,markdownContent:_0xb3afe}=_0x2b1a3b['body'];if(!_0x5c5b45||!_0x1ecea4)throw new Error(_0x5c1831(0x1c2));const _0x317c24=_0x5c5b45+_0x5c1831(0x229),_0x2ec3d7=path[_0x5c1831(0x1f6)](CONFIG[_0x5c1831(0x200)],_0x5c5b45);if(!fs['existsSync'](_0x2ec3d7))throw new Error(_0x5c1831(0x1fc)+_0x5c5b45+_0x5c1831(0x1fd));if(!_0x2d1dda){_0x33a35a[_0x5c1831(0x1fb)](_0x5c1831(0x1f9),'application/octet-stream'),_0x33a35a[_0x5c1831(0x1fb)]('Content-Disposition',_0x5c1831(0x1d4)+_0x317c24+'\x22');const _0x15018b=tar[_0x5c1831(0x1c6)]({'gzip':!![]},[_0x5c5b45]);_0x15018b[_0x5c1831(0x1b0)](_0x33a35a),logger[_0x5c1831(0x216)](_0x5c1831(0x20c)+getRelativePath(_0x2ec3d7));return;}const _0x282c24=path['join'](CONFIG[_0x5c1831(0x200)],_0x2d1dda);if(!fs[_0x5c1831(0x211)](_0x282c24))throw new Error(_0x5c1831(0x1db)+_0x2d1dda+_0x5c1831(0x1fd));const _0xc67944=/!\[.*?\]\([^)]+\)/['test'](_0xb3afe);logger['info'](_0x5c1831(0x1d2)+_0xb3afe+',\x20has\x20images:\x20'+_0xc67944),_0x33a35a[_0x5c1831(0x1fb)](_0x5c1831(0x1f9),_0x5c1831(0x1b3)),_0x33a35a[_0x5c1831(0x1fb)](_0x5c1831(0x222),'attachment;\x20filename=\x22'+_0x317c24+'\x22');const _0x4e84cc=_0xc67944?[_0x5c5b45,_0x2d1dda]:[_0x2d1dda],_0x99407d=tar['create']({'gzip':!![]},_0x4e84cc);_0x99407d[_0x5c1831(0x1b0)](_0x33a35a),logger[_0x5c1831(0x216)](_0x5c1831(0x1e1)+(_0xc67944?_0x5c1831(0x1f2):'MD\x20file\x20only')+_0x5c1831(0x227)+_0x5c5b45+',\x20'+_0x2d1dda);}catch(_0xd9cfeb){_0x4d44ea(_0xd9cfeb);}}),app[a0_0x3ec052(0x1f4)](errorHandler),app[a0_0x3ec052(0x1e8)](CONFIG[a0_0x3ec052(0x1e4)],()=>{const _0x5ccf07=a0_0x3ec052;logger[_0x5ccf07(0x216)](_0x5ccf07(0x204)+CONFIG[_0x5ccf07(0x1e4)]);});